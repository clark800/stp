#!/bin/sh

TITLE="${SSG_TITLE}"
HOME="${SSG_HOME}"
EXT="${SSG_EXTENSION:-md}"
PROCESSOR="${SSG_PROCESSOR:-smu}"
INCLUDES="${SSG_INCLUDES:-.includes}"

println() {
    printf '%s\n' "$1"
}

get_subdirs() {
    find "$1" ! -name "${1##*/}" -prune ! -name '.*' -type d
}

get_recursive_subdirs() {
    find "$1" -name ".?*" -prune -o -type d -print
}

has_subpage() {
    get_subdirs "$1" | {
        while IFS='' read -r subdir; do
            if [ -r "$subdir/index.html" ]; then
                return 0
            fi
        done
        return 1
    }
}

is_generated() {
    grep -q -x '<meta name="generator" content="ssg">' "$1"
}

is_writable() {
    [ ! -e "$1" ] || is_generated "$1"
}

is_category_page() {
    [ -r "$1/index.html" ] && is_generated "$1/index.html" && \
        [ ! -e "$1/index.$EXT" ]
}

titlecase() {
    println "$1" | tr '_ -' '\n\n\n' |
    while IFS='' read -r word; do
        printf ' %.1s' "$word" | tr '[:lower:]' '[:upper:]'
        printf '%s' "${word#?}"
    done | cut -c 2-
}

get_metadata() {
    key="$1"
    html="$2"
    sed -n "s/<meta name=\"$key\" content=\"\(.*\)\">/\1/p" "$html"
}

get_source_title() {
    grep -v '^[[:space:]]*$' "$1" | head -n 1
}

get_html_title() {
    cat "$1" | tr -d '\r\n' | sed -n 's/.*<title>\(.*\)<\/title>.*/\1/p'
}

get_site_title() {
    if [ "$TITLE" ]; then
        println "$TITLE"
    else
        title="$(basename "$(pwd)")"
        if [ "${title%.*}" == "$title" ]; then
            titlecase "$title"
        else
            println "$title"    # contains a period; likely a domain name
        fi
    fi
}

get_index_title() {
    if [ "$1" == "." ]; then
        get_site_title
    else
        titlecase "${1##*/}"
    fi
}

get_page_title() {
    dir="${1%/}"
    index="$dir/index.html"
    if [ -r "$dir/index.$EXT" ]; then
        get_source_title "$dir/index.$EXT"
    elif [ -r "$index" ] && ! is_generated "$index" ; then
        get_html_title "$index"
    else
        get_index_title "$dir"
    fi
}

get_home_title() {
    if [ "$HOME" ]; then
        println "$HOME"
    else
        get_site_title
    fi
}

insert_meta_sed_cmd() {
    printf '/<title>/i\\\n<meta name="%s" content="%s">\n;' "$1" "$2"
}

set_generator() {
    sed "$(insert_meta_sed_cmd generator ssg)"
}

set_title() {
    sed "s|<title>.*</title>|<title>$1</title>|"
}

get_header() {
    title="$1"
    file="$INCLUDES/header.html"
    if [ -r "$file" ]; then
        if is_generated "$file"; then
            cat "$file" | set_title "$title"
        else
            cat "$file" | set_title "$title" | set_generator
        fi
    else
        icon="data:image/png;base64,iVBORw0KGgo="
        println '<!DOCTYPE html>'
        println '<html lang="en">'
        println '<head>'
        println '<meta charset="utf-8">'
        println '<meta name="generator" content="ssg">'
        println "<title>$title</title>"
        println '<link rel="stylesheet" href="/style.css">'
        println "<link rel=\"icon\" type=\"image/png\" href=\"$icon\">"
        println '</head>'
        println '<body>'
        println '<header>'
        println '<nav>'
        println '<a href="/categories.html">Categories</a>'
        println '</nav>'
        println '</header>'
        println '<main>'
    fi
}

set_meta_tags() {
    source="$1"
    command=""
    while read -r line; do
        trimmed="${line#% }"
        if [ "$trimmed" == "$line" ]; then
            continue
        fi
        key="${trimmed%%:*}"
        value="${trimmed#*: }"
        command+="$(insert_meta_sed_cmd "$key" "$value")"
    done < "$source"
    sed "${command%;}"
}

get_footer() {
    if [ -r "$INCLUDES/footer.html" ]; then
        cat "$INCLUDES/footer.html"
    else
        println '</main>'
        println '</body>'
        println '</html>'
    fi
}

gen_breadcrumb() {
    tail="${1%/}"
    if [ "$tail" == "." ]; then
        println '<nav>'
        println '</nav>'
        return
    fi
    tail="${tail%/*}/" # start with parent directory
    tail="${tail#.}"
    tail="${tail#/}"   #  a/b/    b/      ''
    head="/"           # /     /a/   /a/b/
    println "<nav>"
    println "<a href=\"$head\">$(get_home_title)</a> &gt;"
    while [ "$tail" ]; do
        head="$head${tail%%/*}/"
        tail="${tail#*/}"
        label="$(get_page_title ".$head")"
        println "<a href=\"$head\">$label</a>&nbsp;&gt;"
    done
    println "</nav>"
}

gen_listing() {
    dir="$1"
    (cd "$dir"; get_recursive_subdirs .) |
    while IFS='' read -r relpath; do
        path="${dir%/}/${relpath#./}"
        if [ -r "$path/index.html" ]; then
            published="$(get_metadata published "$path/index.html")"
            if [ "$published" ]; then
                println "$published $relpath"
            fi
        fi
    done |
    sort -r -k 1 |
    while IFS='' read -r line; do
        published="${line%% *}"
        relpath="${line#* }"
        path="${dir%/}/${relpath#./}"
        title="$(get_page_title "$path")"
        time="<time>$published</time>"
        println "<h2>$time<a href=\"${relpath#./}\">$title</a></h2>"
    done
}

gen_index_page() {
    dir="$1"
    title="$(get_index_title "$dir")"
    get_header "$title"
    gen_breadcrumb "$dir"
    println "<h1>$title</h1>"
    gen_listing "$dir"
    get_footer
}

gen_metadata() {
    println "<dl>"
    grep '^% ' "$1" | sed "s|^% \([^:]*\): \(.*\)$|<dt>\1</dt><dd>\2</dd>|"
    println "</dl>"
}

process() {
    source="$1"
    gen_metadata "$source" > "$source.tmp"
    grep -v '^% ' "$source" | $PROCESSOR | sed "/<\/h1>/r $source.tmp"
    rm -f "$source.tmp"
}

gen_content_page() {
    source="$1"
    title="$(get_source_title "$source")"
    get_header "$title" | set_meta_tags "$source"
    gen_breadcrumb "${source%/*}"
    process "$source"
    get_footer
}

gen_page() {
    dir="$1"
    for source in "$dir"/*."$EXT"; do
        if [ -r "$source" ] && is_writable "${source%.*}.html"; then
            gen_content_page "$source" > "${source%.*}.html"
        fi
    done
    if [ ! -e "$dir/index.$EXT" ] && is_writable "$dir/index.html"; then
        if has_subpage "$dir"; then
            gen_index_page "$dir" > "$dir/index.html"
        fi
    fi
}

gen_categories_page() {
    root="$1"
    html="$root/categories.html"
    get_header "Categories"
    println "<h1>Categories</h1>"
    println "<ul>"
    get_recursive_subdirs "$root" |
    while IFS='' read -r path; do
        if is_category_page "$path"; then
            title="$(get_page_title "$path")"
            println "<li><a href=\"${path##*/}\">$title</a></li>"
        fi
    done
    println "</ul>"
    get_footer
}

gen_site() {
    get_recursive_subdirs "." |
    LC_ALL=C sort -r |
    while IFS='' read -r dir; do
        gen_page "$dir"
    done
    if is_writable "categories.html"; then
        gen_categories_page "." > "categories.html"
    fi
}


cd "${1:-.}" || exit 1
gen_site
