#!/bin/sh
set -e

TITLE="${SSG_TITLE}"
CONFIG="${SSG_CONFIG:-.ssg}"

println() {
    printf '%s\n' "$1"
}

find_files() {
    find "$1" -name '.?*' -prune -o -type f -name "$2" -print
}

titlecase() {
    tr '_ -' '\n\n\n' |
    while IFS='' read -r word; do
        printf ' %.1s' "$word" | tr '[:lower:]' '[:upper:]'
        printf '%s' "${word#?}"
    done | cut -c 2-
}

format_title() {
    if [ "${1%.*}" == "$1" ]; then
        println "$1" | titlecase
    else
        println "$1"    # contains a period; likely a domain name
    fi
}

get_site_title() {
    if [ "$TITLE" ]; then
        println "$TITLE"
    else
        format_title "$(basename "$(pwd)")"
    fi
}

get_html_title() {
    cat "$1" | tr -d '\r\n' | sed -n 's|.*<title>\(.*\)</title>.*|\1|p'
}

get_meta_value() {
    sed -n "s/<meta name=\"$1\" content=\"\(.*\)\">/\1/p"
}

process_template() {
    eval "printf '%s\\n' \"$(sed 's/"/\\"/g')\""
}

get_header() {
    cat "$CONFIG/templates/header.html" | process_template
}

get_footer() {
    cat "$CONFIG/templates/footer.html" | process_template
}

read_source() {
    grep -v '^%' "$source_path"
}

apply_transforms() {
    if [ ! "$1" ]; then
        cat
    else
        "${1%%;*}" "$source_path" | apply_transforms "${1#*;}"
    fi
}

gen_content_page() {
    cat "$CONFIG/templates/header.html" \
        "$CONFIG/templates/${source_path##*.}.html" \
        "$CONFIG/templates/footer.html" |
        process_template | apply_transforms "$TRANSFORMS"
}

gen_content_pages() {
    ls "$CONFIG/templates" |
    grep -v -x -e 'header.html' -e 'footer.html' |
    while IFS='' read -r template_filename; do
        println "TEMPLATE $template_filename"
        find_files "." "*.${template_filename%%.*}" |
        while IFS='' read -r source_path; do
            dest_path="${source_path%.*}.html"
            println "${dest_path#./}" >&2
            gen_content_page > "$dest_path"
        done
    done
}

register_generator() {
    GENERATORS="$GENERATORS$1;"
}

register_transform() {
    TRANSFORMS="$TRANSFORMS$1;"
}

import_plugins() {
    if [ -r "$CONFIG/plugins" ]; then
        for plugin in "$CONFIG/plugins"/*.sh; do
            if [ -r "$plugin" ]; then
                . "$plugin"
            fi
        done
    fi
}

cd "${1:-.}" || exit 1
import_plugins
gen_content_pages
eval "$GENERATORS"
