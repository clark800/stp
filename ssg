#!/bin/sh
set -e
readonly CONFIG="${SSG_CONFIG:-.ssg}"
ROOT_TITLE="${SSG_ROOT_TITLE:-}"
TITLE_SPACES="${SSG_TITLE_SPACES-_-}"
TITLE_FORMAT="${SSG_TITLE_FORMAT-capitalize}"

println() {
    printf '%s\n' "$1"
}

is_function() {
    [ "$1" != "" ] && [ "$(command -v "$1")" = "$1" ]
}

try() {
    if is_function "${1:?}"; then "$1"; else shift && try "$@"; fi
}

find_files() {
    find "$1" -name '.?*' -prune -o -type f -name "$2" -print
}

capitalize() {
    tr ' ' '\n' |
    while IFS='' read -r word; do
        printf ' %.1s' "$word" | tr '[:lower:]' '[:upper:]'
        printf '%s' "${word#?}"
    done | cut -c 2-
}

format_title() {
    _format() { tr " $TITLE_SPACES" '[ *]' | ${TITLE_FORMAT:-cat}; }
    println "$1" | if [ "${1%.*}" != "$1" ]; then cat; else _format; fi
}

get_directory_title() {
    title="$(format_title "$(basename "$1")")"
    root_title="${ROOT_TITLE:-"$(format_title "$(basename "$(pwd)")")"}"
    if [ "${1%/}" = "." ]; then println "$root_title"; else println "$title"; fi
}

get_file_title() {
    _fallback() { format_title "$(basename "$DEST_PATH" ".${DEST_PATH##*.}")"; }
    try "get_title_${SOURCE_PATH##*.}" _fallback
}

input() {
    cat "${SOURCE_PATH:?}"
}

instantiate() {
    : "${GENERATOR:?}" "${TARGET:?}" "${TITLE:?}" "${DEST_PATH:?}"
    path="${1:+"$CONFIG/templates/$TARGET/$1.$TARGET"}"
    path="${path:-"$SOURCE_PATH"}"
    if grep -q -F -e '\"' -e '\`' "$path"; then
        println "ERROR: template contains \\\" or \\\`: $path" >&2 && exit 1
    fi
    eval "printf '%s\\n' \"$(sed 's/"/\\"/g;s/`/\\`/g' "$path")\""
}

wrap() {
    _cat() { cat; }
    (instantiate header; cat; instantiate footer) | try post_"$TARGET"_hook _cat
}

run_generator() {
    TARGET="${1:?}" GENERATOR="${2:?}" SOURCE_PATH="" DEST_PATH="" TITLE="" "$2"
}

import() {
    if [ -d "$1" ]; then
        for plugin in "$1"/*.sh; do
            if [ -e "$plugin" ]; then . "$plugin"; fi
        done
    fi
}

main() {
    import "$CONFIG/plugins"
    import "$CONFIG/hooks"
    GENERATOR="core"
    for templates in "$CONFIG/templates"/*; do
        TARGET="${templates##*/}"
        ls "$templates" | grep -F ".main.$TARGET" | sort |
        while IFS='' read -r template_filename; do
            find_files "." "*.${template_filename%%.*}" |
            while IFS='' read -r SOURCE_PATH; do
                DEST_PATH="${SOURCE_PATH%.*}.$TARGET"
                println "${DEST_PATH#./}" >&2
                TITLE="$(get_file_title)"
                instantiate "${SOURCE_PATH##*.}.main" | wrap > "$DEST_PATH"
            done
        done
    done
    try post_hook :
}

cd "${1:-.}" || exit 1
main
