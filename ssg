#!/bin/sh

EXT="${SSG_EXTENSION:-md}"
PROCESSOR="${SSG_PROCESSOR:-smu}"
INCLUDES="${SSG_INCLUDES:-includes}"

has_index() {
    [ -e "$1/index.html" ] || [ -e "$1/index.$EXT" ]
}

is_dir() {
    [ -d "$1" ] && [ ! -L "$1" ] && [ "${1##*/}" != "$INCLUDES" ]
}

is_page() {
    is_dir "$1" && has_index "$1"
}

is_category() {
    is_dir "$1" && ! has_index "$1"
}

get_title() {
    dir="$1"
    if [ -e "$dir/index.$EXT" ]; then
        head -n 1 "$dir/index.$EXT"
    elif [ -e "$dir/index.html" ]; then
        cat "$dir/index.html" | tr -d '\r\n' |
            sed -n 's/.*<title>\(.*\)<\/title>.*/\1/p'
    else
        printf "${dir##*/}"
    fi
}

copy_header() {
    title="$(get_title "${1%/*}")"
    header="$INCLUDES/header.html"
    if [ -e "$header" ]; then
        sed "s/<title><\/title>/<title>$title<\/title>/" "$header" > "$1"
    else
        printf '<html>\n<body>\n' > "$1"
    fi
}

add_footer() {
    if [ -e "$INCLUDES/footer.html" ]; then
        cat "$INCLUDES/footer.html" >> "$1"
    else
        printf "</body>\n</html>\n" >> "$1"
    fi
}

gen_index() {
    dir="$1"
    index="$dir/index.html"
    copy_header "$index"
    for path in "$dir"/*; do
        if is_category "$path"; then
            printf "<a href=\"${path##*/}\">$name</a>\n" >> "$index"
        fi
    done
    # todo: sort by date
    for path in "$dir"/*; do
        if is_page "$path"; then
            title="$(get_title "$path")"
            printf "<h2><a href=\"${path##*/}\">$title</a></h2>\n" >> "$index"
        fi
    done
    add_footer "$index"
}

process() {
    cat "$1" |
    sed 's/^% \([^:]*\): \(.*\)$/<dl>\n<dt>\1<\/dt>\n<dd>\2<\/dd>\n<\/dl>/' |
        tr -d '\r' | tr '\n' '\r' | sed 's/<\/dl>\r<dl>\r//' | tr '\r' '\n' |
        "$PROCESSOR" | sed 's/<p><dl>/<dl>/' | sed 's/<\/dl><\/p>/<\/dl>/' >> \
        "${1%.*}.html"
}

gen_page() {
    dir="$1"
    index="$dir/index.html"
    if [ -e "$dir/index.$EXT" ]; then
        copy_header "$index"
        process "$dir/index.$EXT"
        add_footer "$index"
    elif [ ! -e "$index" ]; then
        gen_index "$dir"
    fi
}

gen_site() {
    dir="$1"
    gen_page "$dir"
    for path in "$dir"/*; do
        if is_dir "$path"; then
            gen_site "$path"
        fi
    done
}


gen_site "$(pwd)"
