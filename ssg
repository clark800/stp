#!/bin/sh

EXT="${SSG_EXTENSION:-md}"
PROCESSOR="${SSG_PROCESSOR:-smu}"
INCLUDES="${SSG_INCLUDES:-includes}"
CR="$(printf '\r')"

get_subdirs() {
    find "$1" ! -name "${1##*/}" -prune ! -name '.*' -type d
}

get_recursive_subdirs() {
    find "$1" -name ".?*" -prune -o -type d -print
}

has_subpage() {
    get_subdirs "$1" | {
        while IFS='' read -r subdir; do
            if [ -r "$subdir/index.html" ]; then
                return 0
            fi
        done
        return 1
    }
}

is_generated() {
    grep -q -x '<meta name="generator" content="ssg">' "$1"
}

is_writable() {
    [ ! -e "$1" ] || is_generated "$1"
}

is_content_page() {
    [ -r "$1/index.html" ] &&
        { [ -r "$1/index.$EXT" ] || ! is_generated "$1/index.html"; }
}

titlecase() {
    printf '%s\n' "$1" | tr '_ -' '\n\n\n' |
    while IFS='' read -r word; do
        printf ' %.1s' "$word" | tr '[:lower:]' '[:upper:]'
        printf "${word#?}"
    done | cut -c 2-
}

get_source_title() {
    grep -v '^[[:space:]]*$' "$1" | head -n 1
}

get_html_title() {
    cat "$1" | tr -d '\r\n' | sed -n 's/.*<title>\(.*\)<\/title>.*/\1/p'
}

get_page_title() {
    titledir="${1%/}"
    index="$titledir/index.html"
    if [ -r "$titledir/index.$EXT" ]; then
        get_source_title "$titledir/index.$EXT"
    elif [ -r "$index" ] && ! is_generated "$index" ; then
        get_html_title "$index"
    elif [ "$titledir" == "." ]; then
        titlecase "$(basename "$(pwd)")"
    else
        titlecase "${titledir##*/}"
    fi
}

get_header() {
    if [ -r "$INCLUDES/header.html" ]; then
        cat "$INCLUDES/header.html"
    else
        printf '<!DOCTYPE html>\n<html lang="en">\n<head>\n'
        printf '<meta charset="utf-8">\n'
        printf '<meta name="generator" content="ssg">\n'
        printf '<title></title>\n'
        printf '<link rel="stylesheet" href="/style.css">\n'
        printf '<link rel="icon" type="image/png" '
        printf 'href="data:image/png;base64,iVBORw0KGgo=">\n'
        printf '</head>\n<body>\n<header>\n<nav>\n'
        printf '<a href="/categories.html">Categories</a>\n'
        printf '</nav>\n</header>\n<main>\n'
    fi
}

set_meta_tags() {
    source="$1"
    command=""
    while read -r line; do
        trimmed="${line#% }"
        if [ "$trimmed" == "$line" ]; then
            continue
        fi
        key="${trimmed%%:*}"
        value="${trimmed#*: }"
        command+="s|<title>|<meta name=\"$key\" content=\"$value\">\n<title>|;"
    done < "$source"
    sed "${command%;}"
}

set_title() {
    sed "s|<title></title>|<title>$1</title>|"
}

get_footer() {
    if [ -r "$INCLUDES/footer.html" ]; then
        cat "$INCLUDES/footer.html"
    else
        printf "</main>\n</body>\n</html>\n"
    fi
}

get_metadata() {
    key="$1"
    dir="$2"
    if [ -r "$dir/index.$EXT" ]; then
        sed -n "s/^% $key: \(.*\)$/\1/p" "$dir/index.$EXT"
    elif [ -r "$dir/index.html" ]; then
        sed -n "s/<dt>$key<\/dt><dd>\(.*\)<\/dd>/\1/p" "$dir/index.html"
    fi
}

gen_nav() {
    tail="${1%/}"
    if [ "$tail" == "." ]; then
        printf '<nav>\n</nav>\n'
        return
    fi
    tail="${tail%/*}/" # start with parent directory
    tail="${tail#.}"
    tail="${tail#/}"   #  a/b/    b/      ''
    head="/"           # /     /a/   /a/b/
    printf "<nav>\n"
    printf "<a href=\"$head\">$(get_page_title .)</a> &gt;\n"
    while [ "$tail" ]; do
        head="$head${tail%%/*}/"
        tail="${tail#*/}"
        label="$(get_page_title ".$head")"
        printf "<a href=\"$head\">$label</a>&nbsp;&gt;\n"
    done
    printf "</nav>\n"
}

gen_listing() {
    dir="$1"
    (cd "$dir"; get_recursive_subdirs .) |
    while IFS='' read -r relpath; do
        path="${dir%/}/${relpath#./}"
        if is_content_page "$path"; then
            published="$(get_metadata published "$path")"
            if [ "$published" ]; then
                printf "%s %s\n" "$published" "$relpath"
            fi
        fi
    done |
    sort -r -k 1 |
    while IFS='' read -r line; do
        published="${line%% *}"
        relpath="${line#* }"
        path="${dir%/}/${relpath#./}"
        title="$(get_page_title "$path")"
        printf "<h2><time>$published</time>"
        printf "<a href=\"${relpath#./}\">$title</a></h2>\n"
    done
}

gen_index_page() {
    dir="$1"
    html="$dir/index.html"
    title="$(get_page_title "$dir")"
    get_header | set_title "$title" > "$html"
    gen_nav "$dir" >> "$html"
    printf "<h1>%s</h1>\n" "$title" >> "$html"
    gen_listing "$dir" >> "$html"
    get_footer >> "$html"
}

process() {
    cat "$1" | tr -d '\r' |
    sed "s/^% \([^:]*\): \(.*\)$/<dl>$CR<dt>\1<\/dt><dd>\2<\/dd>$CR<\/dl>/" |
        tr '\n' '\r' | sed "s/$CR<\/dl>$CR<dl>$CR/$CR/" | tr '\r' '\n' |
        $PROCESSOR | sed 's/^<p><dl>$/<dl>/' | sed 's/^<\/dl><\/p>$/<\/dl>/'
}

gen_content_page() {
    source="$1"
    html="${source%.*}.html"
    title="$(get_source_title "$source")"
    get_header | set_meta_tags "$source" | set_title "$title" > "$html"
    gen_nav "${source%/*}" >> "$html"
    process "$source" >> "$html"
    get_footer >> "$html"
}

gen_page() {
    dir="$1"
    for source in "$dir"/*."$EXT"; do
        if [ -r "$source" ] && is_writable "${source%.*}.html"; then
            gen_content_page "$source"
        fi
    done
    if [ ! -e "$dir/index.$EXT" ] && is_writable "$dir/index.html"; then
        if has_subpage "$dir"; then
            gen_index_page "$dir"
        fi
    fi
}

gen_categories_page() {
    root="$1"
    html="$root/categories.html"
    get_header | set_title "Categories" > "$html"
    printf '<h1>Categories</h1>\n<ul>' >> "$html"
    get_recursive_subdirs "$root" |
    while IFS='' read -r path; do
        if is_generated "$path/index.html" && [ ! -e "$path/index.$EXT" ]; then
            title="$(get_page_title "$path")"
            printf "<li><a href=\"${path##*/}\">$title</a></li>\n" >> "$html"
        fi
    done
    printf '</ul>\n' >> "$html"
    get_footer >> "$html"
}

gen_site() {
    get_recursive_subdirs "." |
    LC_ALL=C sort -r |
    while IFS='' read -r dir; do
        gen_page "$dir"
    done
    if is_writable "categories.html"; then
        gen_categories_page "."
    fi
}


cd "${1:-.}"
gen_site
