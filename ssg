#!/bin/sh

EXT="${SSG_EXTENSION:-md}"
TITLE="${SSG_TITLE:-Home}"
PROCESSOR="${SSG_PROCESSOR:-smu}"
INCLUDES="${SSG_INCLUDES:-includes}"

has_subdir() {
    for subdir in "$1"/*; do
        if [ -d "$subdir" ]; then true; fi
    done
    false
}

is_dir() {
    [ -d "$1" ] && [ ! -L "$1" ] && [ "${1##*/}" != "$INCLUDES" ]
}

is_page() {
    is_dir "$1" && ! has_subdir "$1"
}

is_category() {
    is_dir "$1" && has_subdir "$1"
}

titlecase() {
    printf '%s\n' "$1" | tr '_ -' '\n\n\n' |
    while read -r word; do
        printf ' %.1s' "$word" | tr '[:lower:]' '[:upper:]'
        printf "${word#?}"
    done | cut -c 2-
}

get_title() {
    titledir="${1%/}"
    if [ -e "$titledir/index.$EXT" ]; then
        head -n 1 "$titledir/index.$EXT"
    elif [ -e "$titledir/index.html" ]; then
        cat "$titledir/index.html" | tr -d '\r\n' |
            sed -n 's/.*<title>\(.*\)<\/title>.*/\1/p'
    elif [ "$titledir" == '.' ]; then
        printf "$TITLE"
    else
        titlecase "${titledir##*/}"
    fi
}

get_header() {
    header="$INCLUDES/header.html"
    if [ -e "$header" ]; then
        cat "$header"
    else
        printf '<html>\n<head>\n<title></title>\n'
        printf '<link rel="stylesheet" href="/style.css">\n'
        printf '<link rel="icon" type="image/png" '
        printf 'href="data:image/png;base64,iVBORw0KGgo=">\n'
        printf '</head>\n<body>\n'
    fi
}

copy_header() {
    title="$(get_title "${1%/*}")"
    get_header | sed "s/<title><\/title>/<title>$title<\/title>/" > "$1"
}

get_footer() {
    if [ -e "$INCLUDES/footer.html" ]; then
        cat "$INCLUDES/footer.html"
    else
        printf "</body>\n</html>\n"
    fi
}

gen_index() {
    index="$1/index.html"
    copy_header "$index"
    for path in "$1"/*; do
        if is_category "$path"; then
            printf "<a href=\"${path##*/}\">$name</a>\n" >> "$index"
        fi
    done
    # todo: sort by date
    for path in "$1"/*; do
        if is_page "$path"; then
            title="$(get_title "$path")"
            printf "<h2><a href=\"${path##*/}\">$title</a></h2>\n" >> "$index"
        fi
    done
    get_footer >> "$index"
}

gen_nav() {
    tail="${1%/}"
    tail="${tail%/*}/" # start with parent directory
    tail="${tail#.}"
    tail="${tail#/}"   #  a/b/    b/      ''
    head="/"           # /     /a/   /a/b/
    printf "<h6>\n"
    printf "<a href=\"$head\">$TITLE</a> &gt;\n"
    while [ "$tail" ]; do
        head="$head${tail%%/*}/"
        tail="${tail#*/}"
        title="$(get_title ".$head")"
        printf "<a href=\"$head\">$title</a> &gt;\n"
    done
    printf "</h6>\n"
}

process() {
    cat "$1" |
    sed 's/^% \([^:]*\): \(.*\)$/<dl>\n<dt>\1<\/dt>\n<dd>\2<\/dd>\n<\/dl>/' |
        tr -d '\r' | tr '\n' '\r' | sed 's/<\/dl>\r<dl>\r//' | tr '\r' '\n' |
        "$PROCESSOR" | sed 's/<p><dl>/<dl>/' | sed 's/<\/dl><\/p>/<\/dl>/'
}

gen_page() {
    source="$1"
    dest="${source%.*}.html"
    copy_header "$dest"
    gen_nav "${source%/*}" >> "$dest"
    process "$source" >> "$dest"
    get_footer >> "$dest"
}

gen_dir() {
    dir="$1"
    for path in "$dir"/*."$EXT"; do
        if [ -r "$path" ]; then
            gen_page "$path"
        fi
    done
    if [ ! -e "$dir/index.html" ]; then
        gen_index "$dir"
    fi
}

gen_site() {
    find "$1" -name ".?*" -prune -o -type d -print |
    while IFS='' read -r dir; do
        gen_dir "$dir"
    done
}

gen_site "."
